name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras --python ${{ matrix.python-version }}

      - name: Run linting
        run: |
          uv run ruff check src tests
          uv run ruff format --check src tests

      - name: Run unit tests
        run: uv run pytest tests/test_rename.py -v

      - name: Run integration tests
        run: uv run pytest tests/test_integration.py -v

  integration-icechunk:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install wheel-rename
        run: uv sync --all-extras --python 3.12

      - name: Download icechunk wheel from nightly
        run: |
          mkdir -p wheels
          pip download icechunk \
            --index-url https://pypi.anaconda.org/scientific-python-nightly-wheels/simple \
            --no-deps \
            -d ./wheels/ || echo "Download failed, skipping integration test"

      - name: Inspect and rename wheel
        run: |
          if ls wheels/icechunk-*.whl 1> /dev/null 2>&1; then
            uv run wheel-rename inspect wheels/icechunk-*.whl
            uv run wheel-rename rename wheels/icechunk-*.whl icechunk_v1 -o ./wheels/
            ls -la wheels/
          else
            echo "No wheel found, skipping"
          fi

      - name: Install renamed wheel and verify imports
        run: |
          if ls wheels/icechunk_v1-*.whl 1> /dev/null 2>&1; then
            # Create a test venv
            uv venv test-venv --python 3.12
            uv pip install --python test-venv/bin/python wheels/icechunk_v1-*.whl

            # Verify the import works
            test-venv/bin/python -c "
          import icechunk_v1
          print(f'Successfully imported icechunk_v1 version: {icechunk_v1.__version__}')

          # Verify key classes are accessible
          from icechunk_v1 import Repository, IcechunkStore, Session
          print('All key classes imported successfully')
          "
          else
            echo "No renamed wheel found, skipping verification"
          fi
